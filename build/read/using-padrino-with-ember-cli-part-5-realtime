<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="author" content="Mitch Stanley">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>FullStack Stanley | Using Padrino with Ember CLI Part 5: Realtime</title>

      <meta name="twitter:card" content="summary">
      <meta property="og:description" content="In the final installment of my Padrino + Ember series I'd like to show you how to get some basic realtime functionality within your application">
      <meta property="og:title" content="Using Padrino with Ember CLI Part 5: Realtime">
      <meta property="og:url" content="http://fullstackstanley.com/read/using-padrino-with-ember-cli-part-5-realtime">
      <meta property="og:type" content="article">
      <meta property="article:published_time" content="2015-03-12T20:14:00Z">
      <meta property="article:tag" content="Ruby">
      <meta property="article:tag" content="Padrino">
      <meta property="article:tag" content="Ember">
      <meta property="article:tag" content="Ember-CLI">
      <meta property="article:tag" content="Javascript">
      <meta property="article:tag" content="Sequel">
      <meta property="article:tag" content="sqlite">
      <meta property="article:tag" content="Pusher">

      <link href="../stylesheets/application-0178d91a.css" rel="stylesheet" type="text/css" />
      <link href="../stylesheets/rogue-7109134b.css" rel="stylesheet" type="text/css" />
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-42788138-1', 'auto');
        ga('send', 'pageview');
      </script>
    </head>

    <body class="read read_using-padrino-with-ember-cli-part-5-realtime">
      <div class="wrapper-for-content-outside-of-footer">
        <header class="centered-navigation">
	<div class="centered-navigation-wrapper">
		<a href="javascript:void(0)" class="mobile-logo">
			<img src="https://raw.githubusercontent.com/thoughtbot/refills/master/source/images/placeholder_logo_3_dark.png" alt="">
		</a>
		<a href="" class="centered-navigation-menu-button">MENU</a>
		<ul class="centered-navigation-menu">
			<li class="nav-link"><a href="/">Home</a></li>
			<li class="nav-link"><a class="contact" href="#top">Contact</a></li>
		</ul>
	</div>
</header>

        <a name="top"></a>
        <div id="contact">
	<div class="partial-container">
		<h5>Contact</h5>
		<p><a href="http://twitter.com/mitchartemis" target="_blank"><span class="fa fa-twitter"></span> Contact me via Twitter</a></p>
		<p><a href="http://github.com/acoustep" target="_blank"><span class="fa fa-github"></span> Contact me via Github</a></p>
	</div>
</div>

        <div id="container">
          <div id="main">
            	<article>
		<h1>Using Padrino with Ember CLI Part 5: Realtime</h1>
    <div class="tags">
        <a href="/read/categories/ruby">Ruby</a>
        <a href="/read/categories/padrino">Padrino</a>
        <a href="/read/categories/ember">Ember</a>
        <a href="/read/categories/ember-cli">Ember-CLI</a>
        <a href="/read/categories/javascript">Javascript</a>
        <a href="/read/categories/sequel">Sequel</a>
        <a href="/read/categories/sqlite">sqlite</a>
        <a href="/read/categories/pusher">Pusher</a>
    </div>
		<p><em>Posted on Mar 12, 2015</em></p>
		<p><em><strong>Note</strong>: This article was updated on 8th April 2015 thanks to <a href="https://twitter.com/leggetter">Phil</a> from <a href="https://twitter.com/pusher">Pusher</a> with a better solution for preventing duplicate data.  You can see the content of the original post <a href="https://github.com/acoustep/mitchs.pw/blob/68f30561cd725758eccd103b3de98eb24f982bf9/source/read/2015-03-12-using-padrino-with-ember-cli-part-5-realtime.html.markdown">here</a>.</em></p>

<p>In the final installment of my Padrino + Ember series I&rsquo;d like to show you how to get some basic realtime functionality within our application.  We&rsquo;ll be using <a href="http://pusher.com">Pusher</a> to send and receive messages. They have a pretty reasonable free package which includes 100k messages per day, 20 max connections and SSL if you need it.</p>

<p></p>

<p>If you haven&rsquo;t seen the rest of the series you can view them here:</p>

<ul>
<li><a href="/read/using-padrino-with-ember-cli-part-1">Part 1: Setting up the Padrino API</a></li>
<li><a href="/read/using-padrino-with-ember-cli-part-2">Part 2: Setting up Ember CLI to work with Padrino</a></li>
<li><a href="/read/using-padrino-with-ember-cli-part-3-authentication">Part 3: Authentication</a></li>
<li><a href="/read/using-padrino-with-ember-cli-part-4-authorisation">Part 4: Authorisation</a></li>
</ul>

<p><a href="https://github.com/acoustep/padrino-ember-example">You can also view the full source for the application on Github</a></p>

<p>Make sure you&rsquo;ve signed up at <a href="http://pusher.com">pusher.com</a>, make an application and make a note of your app_id, key and secret key.</p>

<h2>Padrino</h2>

<p>Add the Pusher gem to your <code>Gemfile</code> and run <code>bundle install</code>.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">gem</span> <span class="s1">'pusher'</span>
</pre></td></tr></tbody></table>
</div>

<p>Inside your App class in <code>app/app.rb</code> add the following configuration block with your Pusher credentials. For production I do recommend storing these with <a href="https://github.com/bkeepers/dotenv">dotenv</a> but I&rsquo;ll leave that for you to decide.</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>  <span class="n">configure</span> <span class="k">do</span>
    <span class="no">Pusher</span><span class="p">.</span><span class="nf">app_id</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="no">Pusher</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="no">Pusher</span><span class="p">.</span><span class="nf">secret</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>Here are the changes to the posts controller</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="c1"># app/controllers/posts.rb</span>
  <span class="c1"># ...</span>
  <span class="n">post</span> <span class="p">:</span><span class="n">create</span><span class="p">,</span> <span class="ss">map: </span><span class="s2">""</span> <span class="k">do</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">post_params</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">"post"</span><span class="p">].</span><span class="nf">nil?</span>
      <span class="k">return</span> <span class="s1">'{}'</span>
    <span class="k">end</span>
    <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">create</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">"post"</span><span class="p">].</span><span class="nf">except</span><span class="p">(</span><span class="s2">"socket_id"</span><span class="p">)</span>

    <span class="no">Pusher</span><span class="p">[</span><span class="s1">'posts'</span><span class="p">].</span><span class="nf">trigger</span><span class="p">(</span><span class="s1">'new-post'</span><span class="p">,</span>  <span class="p">{</span><span class="ss">post: </span><span class="vi">@post</span><span class="p">.</span><span class="nf">values</span><span class="p">},</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">"post"</span><span class="p">][</span><span class="s2">"socket_id"</span><span class="p">])</span>

    <span class="n">render</span> <span class="s2">"posts/show"</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="n">put</span> <span class="p">:</span><span class="n">update</span><span class="p">,</span> <span class="ss">map: </span><span class="s2">":id"</span> <span class="k">do</span>
    <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]]</span>

    <span class="k">if</span> <span class="vi">@post</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="k">return</span> <span class="s1">'{}'</span>
    <span class="k">end</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">post_params</span>
    <span class="vi">@post</span><span class="p">.</span><span class="nf">update</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">"post"</span><span class="p">].</span><span class="nf">except</span><span class="p">(</span><span class="s2">"socket_id"</span><span class="p">)</span>
    <span class="n">render</span> <span class="s2">"posts/show"</span>

  <span class="k">end</span>
  <span class="c1"># ...</span>
</pre></td></tr></tbody></table>
</div>

<p>We&rsquo;re going to be sending a new parameter called <code>socket_id</code> to our Padrino API from the Ember application.  <code>socket_id</code> is generated from Pusher in the Ember application and is unique for each user.</p>

<p>Notice on lines 8 and 25 we exclude <code>socket_id</code> as we don&rsquo;t have a <code>socket_id</code> field in our posts table to insert.</p>

<p>On line 10 we send the data to Pusher to tell applications that there is a new blog post. The key, <code>posts</code>, is the channel. The first parameter <code>new-post</code> is the event, the second parameter is the data to send and the third parameter is client&rsquo;s socket id.</p>

<p>Sending the client&rsquo;s socket id means that Pusher will not send the event back to the user which created it. This will prevent duplicate data from showing in the poster&rsquo;s Ember application.</p>

<p>That&rsquo;s it for Padrino. It&rsquo;s really that simple!</p>

<p>Before moving onto the Ember part of the application make sure that Pusher is receiving the messages.  The easiest way to do this is to create a post in the Ember app and then go to the debug log in the Pusher dashboard.</p>

<p><img alt="Pusher debugging" src="http://i.imgur.com/gc6N497.png" /></p>

<h2>Ember</h2>

<p>We need to install 2 addons for Ember. One of which is for Pusher and can be installed via command line</p>

<p><code>ember install:addon ember-cli-pusher</code></p>

<p>The other is to deal with CSP (Content Security Policy) when using Pusher.  </p>

<p>Without it we will get an error from our application like the following</p>

<p><code>[Report Only] Refused to load the script &#39;http://stats.pusher.com/timeline/v2/jsonp/1?session=...&#39; because it violates the following Content Security Policy directive: &quot;script-src &#39;self&#39; &#39;unsafe-eval&#39; localhost:35729 0.0.0.0:35729&quot;.</code></p>

<p>To fix this we use <code>ember-cli-content-security-policy</code>.</p>

<p>Let&rsquo;s add it to our <code>package.json</code>.  Currently we can&rsquo;t install it via command line  because there&rsquo;s a bug in the latest tagged release.  We need to get the latest version from Github.</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> <span class="s2">"ember-cli-content-security-policy"</span><span class="err">:</span> <span class="s2">"git://github.com/rwjblue/ember-cli-content-security-policy.git#master"</span><span class="p">,</span>
</pre></td></tr></tbody></table>
</div>

<p>Run <code>npm install</code> afterwards.</p>

<p>Next we&rsquo;ll update <code>config/environment.js</code>.  Make sure you put your Pusher key in the Pusher settings.</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre>    <span class="nx">APP</span><span class="err">:</span> <span class="p">{</span>
      <span class="c1">// Here you can pass flags/options to your application instance</span>
      <span class="c1">// when it is created</span>
      <span class="nl">PUSHER_OPTS</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">key</span><span class="p">:</span> <span class="s1">'&lt;YOURKEY&gt;'</span><span class="p">,</span>
        <span class="na">connection</span><span class="p">:</span> <span class="p">{},</span>
        <span class="na">logAllEvents</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">},</span>
</pre></td></tr></tbody></table>
</div>

<p>We can add these CSP settings with the other ENV related content. Note that Bootstrap CDN is also included for fonts and stylesheets.</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre>  <span class="nx">ENV</span><span class="p">[</span><span class="s1">'contentSecurityPolicy'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default-src'</span><span class="p">:</span> <span class="s2">"'none'"</span><span class="p">,</span>
    <span class="s1">'font-src'</span><span class="p">:</span> <span class="s2">"'self' http://maxcdn.bootstrapcdn.com/"</span><span class="p">,</span>
    <span class="s1">'script-src'</span><span class="p">:</span> <span class="s2">"'self' http://stats.pusher.com/"</span><span class="p">,</span>
    <span class="s1">'connect-src'</span><span class="p">:</span> <span class="s2">"'self' ws://ws.pusherapp.com/"</span><span class="p">,</span> 
    <span class="s1">'img-src'</span><span class="p">:</span> <span class="s2">"'self'"</span><span class="p">,</span>
    <span class="s1">'style-src'</span><span class="p">:</span> <span class="s2">"'self' 'unsafe-inline' http://maxcdn.bootstrapcdn.com/"</span><span class="p">,</span>
    <span class="s1">'media-src'</span><span class="p">:</span> <span class="s2">"'self'"</span><span class="p">,</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table>
</div>

<p>Now that we have Pusher set up we need to generate the controller for the posts/index and modify it to receive the events.</p>

<p><code>ember g controller posts/index</code></p>

<p>In <code>app/controllers/posts/index.js</code> add the following:</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Bindings</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'ember-pusher/bindings'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ArrayController</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Bindings</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">sortProperties</span><span class="p">:</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">],</span>
  <span class="na">sortAscending</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">logPusherEvents</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">PUSHER_SUBSCRIPTIONS</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">posts</span><span class="p">:</span> <span class="p">[</span><span class="s1">'new-post'</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">newPost</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">post</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>

<p>We will switch the controller to an ArrayController so we can sort by <code>id</code> descending (so that newer posts appear at the top). Using the pusher library we subscribe to the posts channel and the <code>new-post</code> event. Note that when there is a <code>new-post</code> event an action is called with the camel-case version of the name. In this case <code>new-post</code> becomes <code>newPost</code>.</p>

<p>Inside of the <code>newPost</code> action we use <code>store.push</code> which will find the post if it&rsquo;s already there or create it otherwise.  </p>

<p>Here is the newly updated <code>posts/index.hbs</code></p>
<div class="highlight html"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></td><td class="code"><pre><span class="nt">&lt;h3&gt;</span>Latest Posts<span class="nt">&lt;/h3&gt;</span>
<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">“col-md-3”</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"col-md-3"</span><span class="nt">&gt;</span>Created at<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"col-md-3"</span><span class="nt">&gt;</span>Last modified<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"col-md-3"</span><span class="nt">&gt;</span>Actions<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
{{#each post in arrangedContent}}
<span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td&gt;</span>{{ post.title }}<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td&gt;</span>{{ post.createdAt }}<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td&gt;</span>{{ post.updatedAt }}<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td&gt;</span>
    {{#link-to 'posts.show' post classNames="btn btn-success"}}View{{/link-to}}
    {{#if session.isAuthenticated}}
      {{#link-to 'posts.edit' post classNames="btn btn-info"}}Edit{{/link-to}}
      <span class="nt">&lt;button</span> <span class="err">{{</span><span class="na">action</span> <span class="err">'</span><span class="na">delete</span><span class="err">'</span> <span class="na">post</span><span class="err">}}</span> <span class="na">class=</span><span class="s">"btn btn-danger"</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/button&gt;</span>
    {{/if}}
  <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
{{/each}}
<span class="nt">&lt;/table&gt;</span>
{{#if session.isAuthenticated}}
  {{#link-to 'posts.new' classNames="btn btn-primary"}}
    New Post
  {{/link-to}}
{{/if}}
</pre></td></tr></tbody></table>
</div>

<p>Note that we&rsquo;re looping through <code>arrangedContent</code> now so that we that the data is ordered by ID descending.</p>

<p>At this point posts will get pushed to the on top until we hit an id of 10 which mysteriously goes to the bottom of the collection.  This is because Ember&rsquo;s sort works with strings not integers. The simplest solution is to switch <code>id</code> out for <code>createdAt</code> in your <code>posts/index</code> controller.</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nx">sortProperties</span><span class="err">:</span> <span class="p">[</span><span class="s1">'createdAt'</span><span class="p">],</span>
</pre></td></tr></tbody></table>
</div>

<p>As mentioned in the Padrino part of the article we need to add a new parameter, <code>socketId</code> to the <code>post</code> model.</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="c1">// app/models/post.js</span>
<span class="kr">import</span> <span class="nx">DS</span> <span class="nx">from</span> <span class="s1">'ember-data'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">title</span><span class="p">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'string'</span><span class="p">),</span>
  <span class="na">content</span><span class="p">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'string'</span><span class="p">),</span>
  <span class="na">createdAt</span><span class="p">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'string'</span><span class="p">),</span>
  <span class="na">updatedAt</span><span class="p">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'string'</span><span class="p">),</span>
  <span class="na">socketId</span><span class="p">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'string'</span><span class="p">)</span>
<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>

<p><code>socketId</code> will need to be sent when we create a new post. To do this we need to edit the <code>save</code> action in <code>app/routes/posts/new.js</code>.</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre>  <span class="c1">// ...</span>
  <span class="nl">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">save</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelFor</span><span class="p">(</span><span class="s1">'posts/new'</span><span class="p">)</span>

      <span class="nx">post</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'socketId'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pusher</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'socketId'</span><span class="p">));</span>

      <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'posts.index'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>

</pre></td></tr></tbody></table>
</div>

<p>Notice how we get the model and assign the pusher <code>socketId</code> before saving it to the server.</p>

<h3>Notification messages</h3>

<p>Maybe you don&rsquo;t want new data to be pushed on top all of the time.  This is a valid opinion, especially when considering the end user - who might be in the middle of reading a particularly long title. They might not appreciate the browser scrolling down all of the time and losing their place.</p>

<p>At this point I think something similar to how Twitter&rsquo;s website deals with new tweets would be ideal.  We&rsquo;ll show a little box with a message saying &ldquo;1 New Post&rdquo; and allow the user to click it to insert any new posts.</p>

<p>In <code>app/controllers/posts/index.js</code> update the code to the following</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td class="code"><pre><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Bindings</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'ember-pusher/bindings'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ArrayController</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Bindings</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">sortProperties</span><span class="p">:</span> <span class="p">[</span><span class="s1">'createdAt'</span><span class="p">],</span>
  <span class="na">sortAscending</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">logPusherEvents</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">PUSHER_SUBSCRIPTIONS</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">posts</span><span class="p">:</span> <span class="p">[</span><span class="s1">'new-post'</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="na">newPosts</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">newPostCount</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'newPosts.length'</span><span class="p">);</span>
  <span class="p">}.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'newPosts.length'</span><span class="p">),</span>
  <span class="nx">newPostsExist</span><span class="err">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'newPostCount'</span><span class="p">);</span>
  <span class="p">}.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'newPostCount'</span><span class="p">),</span>
  <span class="nx">newPostMessage</span><span class="err">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wording</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'newPostCount'</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">?</span> <span class="s2">"New Posts"</span> <span class="p">:</span> <span class="s2">"New Post"</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'newPostCount'</span><span class="p">)</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nx">wording</span><span class="p">;</span>
  <span class="p">}.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'newPostCount'</span><span class="p">),</span>
  <span class="nx">actions</span><span class="err">:</span> <span class="p">{</span>
    <span class="nl">newPost</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">hasRecordForId</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'newPosts'</span><span class="p">).</span><span class="nx">pushObject</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">post</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">refresh</span><span class="err">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'newPosts'</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="nx">post</span><span class="p">));</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'newPosts'</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>

<p>On line 11 we have a new property <code>newPosts</code> which by default is an empty array. Every time a new post is sent to Ember we will store it in here.</p>

<p>On line 12-14 we have a computed property called <code>newPostCount</code> which counts the number of posts we have stored in the <code>newPosts</code> array.</p>

<p>On lines 15-17 we have a computed property called <code>newPostsExist</code> which returns a boolean value for our template.  The double exclamation mark converts the <code>newPosts</code> length to false if it&rsquo;s 0 and true otherwise.</p>

<p>Lines 18-21 sets up the message we want to display to the user when a new post is available. This will be either &ldquo;1 New Post&rdquo; or &ldquo;x New Posts&rdquo;.</p>

<p>In the <code>newPost</code> action on lines 23-27 instead of pushing the post into the store we put it in the <code>newPosts</code> array for later.</p>

<p>The refresh action on lines 28-33 will be a click event in our template which takes each post and pushes them into our store.</p>

<p>Each computed property has the following code: <code>newPosts.@each</code>.  This allows them to watch for when the array has items added or removed.  This is ideal so that we can tell the user how many new posts there are.</p>

<p>Here is the new template in <code>app/templates/posts/index.hbs</code></p>
<div class="highlight html"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></td><td class="code"><pre><span class="nt">&lt;h3&gt;</span>Latest Posts<span class="nt">&lt;/h3&gt;</span>
{{#if newPostsExist}}
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-info click"</span> <span class="err">{{</span><span class="na">action</span> <span class="err">'</span><span class="na">refresh</span><span class="err">'}}</span><span class="nt">&gt;</span>
    {{ newPostMessage }}
  <span class="nt">&lt;/div&gt;</span>
{{/if}}
<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">“col-md-3”</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"col-md-3"</span><span class="nt">&gt;</span>Created at<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"col-md-3"</span><span class="nt">&gt;</span>Last modified<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"col-md-3"</span><span class="nt">&gt;</span>Actions<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
{{#each post in arrangedContent}}
<span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td&gt;</span>{{ post.title }}<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td&gt;</span>{{ post.createdAt }}<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td&gt;</span>{{ post.updatedAt }}<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td&gt;</span>
    {{#link-to 'posts.show' post classNames="btn btn-success"}}View{{/link-to}}
    {{#if session.isAuthenticated}}
      {{#link-to 'posts.edit' post classNames="btn btn-info"}}Edit{{/link-to}}
      <span class="nt">&lt;button</span> <span class="err">{{</span><span class="na">action</span> <span class="err">'</span><span class="na">delete</span><span class="err">'</span> <span class="na">post</span><span class="err">}}</span> <span class="na">class=</span><span class="s">"btn btn-danger"</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/button&gt;</span>
    {{/if}}
  <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
{{/each}}
<span class="nt">&lt;/table&gt;</span>
{{#if session.isAuthenticated}}
  {{#link-to 'posts.new' classNames="btn btn-primary"}}
    New Post
  {{/link-to}}
{{/if}}
</pre></td></tr></tbody></table>
</div>

<p>We bind the click event <code>refresh</code> to the new alert so when a user clicks the message they receive the new posts and the alert gets removed.</p>

<p>Feel free to add some CSS or use anchor tags so that the cursor changes on hover and encourages the user to click!</p>
<div class="highlight css"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="nc">.click</span> <span class="p">{</span>
  <span class="nl">cursor</span><span class="p">:</span> <span class="nb">pointer</span><span class="p">;</span>
  <span class="nl">cursor</span><span class="p">:</span> <span class="n">hand</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p><img alt="Final app" src="http://i.imgur.com/nQWToRN.png" /></p>

<h2>Summary</h2>

<p>In this post we&rsquo;ve covered 2 ways of using Pusher to handle notifications. One where new posts get added directly to the store and another where we hold on to changes and let the user handle updates.  </p>

<p>I hope you have enjoyed this series and learned how awesome it is to use Padrino with Ember. Don&rsquo;t forget to check out the full source on <a href="https://github.com/acoustep/padrino-ember-example">Github</a>!</p>

	</article>
  <hr>
  <h2>About the Author</h2>
  <div id="about-me">
	<div class="partial-container">
    <p>Hi, I'm Mitch and I'm a 26 year old programmer from the UK.</p>
    
    <p>I work for a web design agency in Telford called The Studio 4 where I build web applications with many different languages and tools.</p>

		<p>In my spare time I do many things. I like to read books, lift weights, play guitar, play video games and write these articles!</p>
	</div>
</div>

	<div class="pagination">
		<ul>
			<li class="page-prev"><a href="/">Back to Latest Blogs</a></li>
		</ul>
	</div>
	<div id="disqus_thread"></div>
	<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		        var disqus_shortname = 'mitchstanleysblog'; // required: replace example with your forum shortname
				
				        /* * * DON'T EDIT BELOW THIS LINE * * */
						        (function() {
	            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	        })();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></span></a></a></noscript></script></div>

          </div>
        </div>
        <div class="push"></div>
      </div>

      <footer class="footer-2">
        <div class="partial-container">
          <ul>
            <li><a class="contact" href="#">Contact</a></li>
          </ul>

          <div class="footer-secondary-links">
            <ul class="footer-social">
              <li>
                <a href="https://twitter.com/mitchartemis"><span class="fa fa-twitter"></span></a>
              </li>
              <li>
                <a href="https://github.com/acoustep"><span class="fa fa-github"></span></a>
              </li>
            </ul>
          </div>
        </div>
      </footer>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
      <script src="../javascripts/application-678994e1.js" type="text/javascript"></script>
    </body>
  </html>
